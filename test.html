<!doctype html>
<title>Tests</title>
<script src="tokenizer.js"></script>
<script src="parser.js"></script>
<script src="http://code.jquery.com/jquery-2.1.1.min.js"></script>
<script>
    function BackgroundBlendModePolyfill(options) {
        // set defaults
        this.options = {
            selector: '*',
            usePolyfillIf: function () {
                /*if (navigator.appName == 'Microsoft Internet Explorer') {
                var agent = navigator.userAgent;
                if (agent.match(/MSIE ([0-9]{1,}[\.0-9]{0,})/) != null) {
                var version = parseFloat(RegExp.$1);
                if (version < 11)
                return true;
                }
                }
                return false;
                */
                return true;
            }
        };
        if (options) {
            var obj = this;
            $.each(options, function (k, v) {
                obj.options[k] = v;
            });
        }

        if (this.options.usePolyfillIf())
            this.walk_css_tree();
    }

    // singleton initializer
    BackgroundBlendModePolyfill.initialize = function (options) {
        if (BackgroundBlendModePolyfill.singleton == null)
            BackgroundBlendModePolyfill.singleton = new BackgroundBlendModePolyfill(options);
        return BackgroundBlendModePolyfill.singleton;
    };

    // handle mouse events w/ support for pointer-events: none
    BackgroundBlendModePolyfill.prototype.walk_css_tree = function () {
        $(this.options.selector).each(function (i) {
            var g = window.getComputedStyle(this, null);
            var s = g["background-blend-mode"];
            //if (s && s != "normal") {
            if(true){
                var b = g.backgroundImage;

                var getRule = function(s) {
                    var retval = "bar{";
                    for(var x = 0; x < s.length; x++) {
                        retval += s[x] + ":" + g[s[x]] + ";\n";
                    }
                    retval += "}";
                    return retval;
                }

                var getNumber = function(rule) {
                    for(var x = 0; x < rule.value.length; x++) {
                        if(rule.value[x].tokenType == "NUMBER") {
                            return rule.value[x].value;
                        }
                    }

                    return 0;
                }

                var getURLS = function(rule) {
                    var a = [];
                    for(var x = 0; x < rule.value.length; x++) {
                        if(rule.value[x].tokenType == "URL") {
                            a.push(rule.value[x].value);
                        } else {
                            a.push(rule.value[x]);
                        }
                    }

                    return a;
                }

                var getFunction = function(rule) {
                    var s = "";
                    if(Object.getPrototypeOf(rule).type == "FUNCTION") {
                        s += rule.name + "(";
                        for(var x = 0; x < rule.value.length; x++) {
                            if(x)
                                s += ", ";

                            s += getNumber(rule.value[x]);
                        }

                        s += ")";

                    }

                    return s;
                }

                var getColor = function(rule) {
                    if(Object.getPrototypeOf(rule).tokenType == "IDENT")
                        return rule.value;

                    var s = rule.name + "(";
                    for(var x = 0; x < rule.value.length; x++) {
                        if(x)
                            s += ", ";

                        var colorval;
                        for(var y = 0; y < rule.value[x].value.length; y++)
                            if(rule.value[x].value[y].tokenType != "WHITESPACE")
                                colorval = rule.value[x].value[y].value;
                        s += colorval;
                    }
                    s += ")";

                    return s;
                }

                function CSSExtract(a, x) {
                    return a[x%(a.length)];
                }

                var rule = getRule(["background-image", 
                                    "background-blend-mode", 
                                    "background-color",
                                    "background-size",
                                    "background-repeat",
                                    "background-position"]);
                var tokens = tokenize(rule);
                var sheet = parse(tokens).value[0].value;
                var width = $(this).width();
                var height = $(this).height();

                var parseBackgrounds = function() {
                    var retval = {};

                    retval.images = getURLS(sheet[0]);
                    var numImages = retval.images.length;

                    var offset = 0;
                    var bksize = sheet[3].value;
                    retval.sizes = [];
                    for(var x = 0; x < numImages; x++, offset++) {
                        var entry = bksize[offset];

                        while(entry.tokenType == "DELIM" || entry.tokenType == "WHITESPACE")
                            entry = bksize[++offset];

                        var xsize = entry.value;
                        if (entry.tokenType == "DIMENSION") {
                            xsize = entry.num;
                        } else if (entry.tokenType == "PERCENTAGE") {
                            xsize = width * entry.value / 100;
                        }
                        entry = bksize[++offset];

                        if(entry == undefined) {
                            ysize = xsize;
                        } else {
                            while(entry.tokenType == "DELIM" || entry.tokenType == "WHITESPACE")
                                entry = bksize[++offset];

                            var ysize = entry.value;
                            if (entry.tokenType == "DIMENSION") {
                                ysize = entry.num;
                            } else if (entry.tokenType == "PERCENTAGE") {
                                ysize = height * entry.value / 100;
                            }
                        }
                        var imgwidth;
                        var imgheight;

                        if(xsize == "auto" && ysize == "auto") {
                            if(htmlimages[x]){
                                imgwidth = htmlimages[x].width;
                                imgheight = htmlimages[x].height;
                            } else {
                                imgwidth = width;
                                imgheight = height;
                            }
                        } else if(xsize == "auto") {
                            imgheight = ysize;
                            if(htmlimages[x])
                                imgwidth = htmlimages[x].width/htmlimages[x].height*imgheight;
                            else 
                                imgwidth = width;
                        } else if(ysize == "auto") {
                            imgwidth = xsize;
                            if(htmlimages[x])
                                imgheight = htmlimages[x].height/htmlimages[x].width*imgwidth;
                            else 
                                imgheight = height;
                        } else {
                            imgwidth = xsize;
                            imgheight = ysize;
                        }
                        retval.sizes[x] = { width: imgwidth, height: imgheight};
                    }

                    retval.repeat = [];
                    var bkrepeat = sheet[4].value;
                    offset = 0;
                    for(var x = 0; x < numImages; x++, offset++) {
                        var entry = bkrepeat[offset];

                        while(entry.tokenType == "DELIM" || entry.tokenType == "WHITESPACE")
                            entry = bkrepeat[++offset];

                        retval.repeat[x] = entry.value;
                    }

                    retval.position = [];
                    var bkposition = sheet[5].value;
                    offset = 0;
                    for(var x = 0; x < numImages; x++, offset++) {
                        var entry = bkposition[offset];
                        var add = true;

                        while(entry.tokenType == "DELIM" || entry.tokenType == "WHITESPACE")
                            entry = bkposition[++offset];

                        var xpos = entry.value;
                        if (entry.tokenType == "IDENT") {
                            if(retval.repeat[x] == "repeat" || retval.repeat[x] == "repeat-x")
                                xpos = 0;
                            else if(entry.value == "left")
                                xpos = 0;
                            else if(entry.value == "right") {
                                xpos = width - retval.sizes[x].width;
                                add = false;
                            } else if(entry.value == "center")
                                xpos = width/2;

                            entry = bkposition[++offset];

                            while(entry.tokenType == "WHITESPACE")
                                entry = bkposition[++offset];

                            if (entry.tokenType == "DIMENSION") {
                                xpos += add?entry.num:-entry.num;
                            }

                            add = true;

                        } else if (entry.tokenType == "DIMENSION") {
                            xpos = entry.num;
                        } else if (entry.tokenType == "PERCENTAGE") {
                            xpos = width * entry.value / 100;
                        }

                        entry = bkposition[++offset];

                        while(entry.tokenType == "DELIM" || entry.tokenType == "WHITESPACE")
                            entry = bkposition[++offset];

                        var ypos = entry.value;
                        if (entry.tokenType == "IDENT") {
                            if(retval.repeat[x] == "repeat" || retval.repeat[x] == "repeat-y")
                                ypos = 0;
                            else if(entry.value == "top")
                                ypos = 0;
                            else if(entry.value == "bottom") {
                                ypos = height - retval.sizes[x].height;
                                add = false;
                            } else if(entry.value == "center")
                                ypos = height/2;

                            entry = bkposition[++offset];

                            while(entry.tokenType == "WHITESPACE")
                                entry = bkposition[++offset];

                            if (entry.tokenType == "DIMENSION") {
                                ypos += add?entry.num:-entry.num;
                            }
                        } else if (entry.tokenType == "DIMENSION") {
                            ypos = entry.num;
                        } else if (entry.tokenType == "PERCENTAGE") {
                            ypos = height * entry.value / 100;
                        }

                        retval.position[x] = { x: xpos, y: ypos};
                    }

                return retval;
                }

                var radians = function(degrees) {
                    return degrees * Math.PI / 180;
                };

                var degrees = function(radians) {
                    return radians / Math.PI * 180;
                };

                ////////////////////////
                var images = getURLS(sheet[0]);
                var htmlimages = [];
                var cnt = 0;

                var createGradient = function(info) {
                    var canv;
                    if (info.name == "linear-gradient" || info.name == "radial-gradient") {
                        canv = document.createElement("canvas");
                        canv.width = width;
                        canv.height = height;
                    }

                    var offset = 0;
                    var stops = [];
                    var colors = [];
                    var angle = 0;
                    if (info.name == "linear-gradient" ) {
                        for(var x = 0; x < info.value.length; x++) {
                            var stopFunction = info.value[x];
                            var stop;
                            var stoppos = NaN;
                            var SetAngle = false;
                            for(var y = 0; y < stopFunction.value.length; y++) {
                                if(stopFunction.value[y].tokenType != "WHITESPACE") {
                                    if(stopFunction.value[y].tokenType == "DIMENSION") {
                                        SetAngle = true;
                                        angle = stopFunction.value[y].num;
                                    } else if(stopFunction.value[y].tokenType == "PERCENTAGE")
                                        stoppos = stopFunction.value[y].value/100;
                                    else
                                        stop = stopFunction.value[y];
                                }

                            }
                            if(!SetAngle) {
                                stops.push(stoppos);
                                colors.push(getColor(stop));
                            }
                        }
                    }
                    else if (info.name == "radial-gradient" )
                        for(var x = 0; x < info.value.length; x++) {
                            var stopFunction = info.value[x];
                            var stop;
                            var stoppos = NaN;
                            var SetAngle = false;
                            for(var y = 0; y < stopFunction.value.length; y++) {
                                if(stopFunction.value[y].tokenType != "WHITESPACE") {
                                    if(stopFunction.value[y].tokenType == "PERCENTAGE")
                                        stoppos = stopFunction.value[y].value/100;
                                    else
                                        stop = stopFunction.value[y];
                                }

                            }
                            stops.push(stoppos);
                            colors.push(getColor(stop));
                        }

                    if(isNaN(stops[0]))
                        stops[0] = 0;

                    if(isNaN(stops[stops.length-1]))
                        stops[stops.length-1] = 1.0;

                    var curval = 0;
                    for(var x = 0; x < stops.length; x++) {
                        if(stops[x] < curval)
                            stops[x] = curval;

                        if(!isNaN(stops[x]))
                            curval = stops[x];
                    }

                    for(var x = 0; x < stops.length; x++) {
                        if(isNaN(stops[x])) {
                            var prev = stops[x-1];
                            var next = NaN;
                            var y = x+1;
                            while(isNaN(stops[y]))
                                y++;

                            stops[x] = prev + (stops[y] - prev) / (y-x+1);
                        }    
                    }
                    

                    if (info.name == "linear-gradient") {
                        var hyp = Math.sqrt(width*width/4 + height*height/4);
                        var baseangle = degrees(Math.asin(width/2/hyp));

                        // normalize angle
                        while(angle<0)
                            angle += 360;
                        angle %= 360;

                        var length;
                        var reducedAngle = angle%180;
                        if(reducedAngle>90)
                            reducedAngle = 180 - reducedAngle;
                        if(reducedAngle <= baseangle)
                            length = hyp*Math.cos(radians(baseangle-reducedAngle));
                        else
                            length = hyp*Math.cos(radians(reducedAngle-baseangle));

                        var offsetx = Math.sin(radians(angle)) * length;
                        var offsety = Math.cos(radians(angle)) * length;

                        var ctx = canv.getContext("2d");;
                        var grad = ctx.createLinearGradient(width/2 - offsetx,height/2 + offsety,width/2 + offsetx,height/2 - offsety);
                        for(var x = 0; x < stops.length; x++) 
                            grad.addColorStop(stops[x], colors[x]);

                        ctx.fillStyle = grad;
                        ctx.fillRect(0,0,width, height);
                    } else if(info.name == "radial-gradient") {
                        var ctx = canv.getContext("2d");;
                        var grad = ctx.createRadialGradient(height/2,height/2,0,height/2,height/2, Math.sqrt(2)*height/2);
                        for(var x = 0; x < stops.length; x++) 
                            grad.addColorStop(stops[x], colors[x]);

                        ctx.save();
                        ctx.scale(width/height, 1);
                        ctx.fillStyle = grad;
                        ctx.fillRect(0,0,width, height);
                        ctx.restore();
                    }

                    return canv;
                }

                var DoDraw = function(){
                    cnt++;
                    if(cnt<images.length)
                        return;

                    var info = parseBackgrounds();

                    var canvaselement = $("#c").get(0);
                    canvaselement.width = width;
                    canvaselement.height = height;
                    var ctx = canvaselement.getContext("2d");

                    ctx.fillStyle = getFunction(sheet[2].value[0]);
                    ctx.fillRect(0,0,width, height);

                    for(var x = images.length-1; x >=0; x--) {
                        var paint = htmlimages[x];
                        var imgwidth;
                        var imgheight;
                        if (!paint) { // gradient
                            paint = createGradient(images[x]);
                            imgwidth = width;
                            imgheight = height;
                        } else {
                            imgwidth = htmlimages[x].width;
                            imgheight = htmlimages[x].height;                          
                        }
                        if(CSSExtract(info.repeat, x) == "no-repeat")
                            ctx.drawImage(paint, CSSExtract(info.position, x).x, CSSExtract(info.position, x).y, imgwidth, imgheight, 0, 0, CSSExtract(info.sizes, x).width, CSSExtract(info.sizes, x).height);
                        else {
                            var repeatstring = CSSExtract(info.repeat, x);
                            var pattern = ctx.createPattern(paint, CSSExtract(info.repeat, x));
                            ctx.save();

                            var scaleX = CSSExtract(info.sizes, x).width/imgwidth;
                            var scaleY = CSSExtract(info.sizes, x).height/imgheight;
                            ctx.translate(CSSExtract(info.position, x).x, CSSExtract(info.position, x).y);
                            ctx.scale(scaleX, scaleY);

                            ctx.fillStyle = pattern;
                            
                            var xpos = 0;
                            var ypos = 0;
                            if(repeatstring == "repeat" || repeatstring == "repeat-x") {
                                xpos -= width/scaleX;
                            }
                            if(repeatstring == "repeat" || repeatstring == "repeat-y") {
                                ypos -= height/scaleY;
                            }
                            ctx.fillRect(xpos,ypos,width/scaleX*2, height/scaleY*2);
                            ctx.restore();
                        }
                    }
                }

                var CallDoDraw = true;
                for(var x = 0; x < images.length; x++) {
                    if(typeof images[x] === "string") {
                        CallDoDraw = false;
                        var img = new Image();
                        htmlimages.push(img);
                        img.onload = DoDraw;
                        img.src = images[x];
                    }
                    else 
                        htmlimages.push(undefined);
                }
                if(CallDoDraw)
                    DoDraw();
            }
        });
    };
</script>
<script>
    $(document).ready(function () {
        BackgroundBlendModePolyfill.initialize({selector: "#b"});
    });
</script>
<style>
div, canvas
{
    width: 600px;
    height: 400px;
    border: solid;
}
#b 
{
    /*
    background: url("no-profile.png"), url("current.jpg");
    backgrolund-blend-mode: multiply;
    background-size: 30% 100px, auto 500px;
    background-repeat: repeat no-repeat, no-repeat repeat ;
    background-position: bottom 30px right 1cm, 37.7952766418457px 30px;
    */
    /*background-size: 30% 100px;
    background-position: bottom 30px right 1cm;
    */
    background-image: radial-gradient(yellow, green 20%, purple, rgb(255, 127, 0));
}
</style>
<body>
<div id="b"></div>
<br>
<canvas id="c"></canvas>
</body>
</html>
